<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Microsite</title>
    <link href="css/basic.css" rel="stylesheet">
    <link href="css/heart.css" rel="stylesheet">
    <link href="css/handcash.css" rel="stylesheet">
    <link id="mystyle" href="css/style_1.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.1.2/socket.io.min.js" integrity="sha384-toS6mmwu70G0fw54EGlWWeA4z3dyJ+dlXBtSURSKN4vyRFOcxd3Bzjj/AoOwY+Rg" crossorigin="anonymous"></script>
    <script src="https://tonicpow.com/scripts/tonicpow.js"></script>
    <style>
        .hero{
            background-image:linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url("assets/hero_1.jpg");
            height: 380px;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            position: relative;
        }
        .hero > h1,h4{
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
        }
        .hero h1{
            top:40%;
        }
        .hero h4{
            top:55%;
        }
        .menu{
            color: white;
            position: absolute;
            right: 30px;
            top:18px;
        }
        .menu a{
            margin: 0 10px;
            color: white;
            text-decoration:none;
        }
        .section{
            padding:60px;
        }
        .section h1{
            text-align:center;
        }
        .onecolumn{
            display:flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
        }
        .twocolumns{
            display:flex;
            justify-content: center;
        }
        .twocolumns>div{
            margin:20px;
        }
        @media only screen and (max-width: 900px) {
            .twocolumns{
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .twocolumns>div{
                margin:20px 0px;
            } 
        }
        @media only screen and (max-width: 618px) {
            #section3{
                padding:0px;
            }
            .twocolumns iframe{
                width: 100%;
                height:100%;
            } 
        }
        .pancake{
            flex-wrap:wrap;
        }
        .pancake > div{
            flex: 1 1 150px;
        }
        .textarea{
            white-space: pre-wrap;
        }

    </style>
    <script>
        TonicPow.shareButton('myButton',{ 
            authText: "Share & Earn Bitcoin" 
        })
    </script>
    <script src="dist/bsv.browser.min.js"></script>
    <script src="dist/run.browser.min.js"></script>
    <script src="jigclass.js"></script>
    <script src="main.js"></script>        
</head>
<body>
    <section class="hero">
        <div class="menu">
            <a href="#section1" id="menu_sec1">Section 1</a>
            <a href="#section2" id="menu_sec2">Section 2</a>
            <a href="#section3" id="menu_sec3">Section 3</a>
        </div>
        <h1 id="sitetitle">Site Title</h1>
        <h4 id="subtitle">This is a subtitle.</h4>
    </section>
    <div class="section" id='section1'>
        <h1 id="head_sec1">Section 1</h1>
        <div class="onecolumn textarea" id="txt_sec1">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
            <br>Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Ut aliquam purus sit amet. In arcu cursus euismod quis viverra nibh cras. Malesuada fames ac turpis egestas maecenas pharetra convallis.
        </div>
    </div>
    <div class="section clr" id='section2'>
            <h1 id="head_sec2">Section 2</h1>
            <div class="twocolumns">
                <div class="textarea" id="txt_sec2">
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Sit amet purus gravida quis blandit turpis cursus in hac. Aliquet eget sit amet tellus cras adipiscing enim eu. Porttitor massa id neque aliquam vestibulum morbi. Pharetra convallis posuere morbi leo urna molestie. Leo a diam sollicitudin tempor id eu nisl. Aliquam faucibus purus in massa tempor nec feugiat nisl. In vitae turpis massa sed elementum tempus egestas sed. Fusce id velit ut tortor pretium. Semper auctor neque vitae tempus quam pellentesque. Mauris augue neque gravida in fermentum et. Viverra tellus in hac habitasse platea dictumst.</p>
                    <p>Suspendisse faucibus interdum posuere lorem ipsum dolor sit amet consectetur. Ipsum nunc aliquet bibendum enim facilisis gravida neque convallis a. Aliquam sem fringilla ut morbi tincidunt.<p>
                </div>
                <div>
                    <img id="img_sec2" src="assets/sample_1.jpg" width="300" height="300">
                </div>
            </div>
    </div>
    <div class="section" id='section3'>
        <h1 id="head_sec3">Section 3</h1>
        <div class="twocolumns pancake">
            <div id="embed_sec3">
                <iframe width="560" height="315" src="https://www.youtube.com/embed/irNJT4aS2JU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <div id='tip-widget'>
                <div class="tipjar_container"> <!--chatbox-->
                    <p style="text-align:center">Real-time Tip Jar</p>
                    <ul id="messages">
                    </ul>
                </div>      
                <div id='tip-input'> <!--heartbox-->
                    <button id="unlockheartbtn" class="btn" onclick="unlockheart()">Unlock Real-time Tipping</button>
                    <div id="heartdiv">
                        <div id="bubblehearts" class="particletext hearts"></div>
                        <div class='heartbtn_container disabled'>
                                <div id="heartamount" class="heartbtn" draggable="true" ondrag="btnanime()" ondragstart="firehearts(event)" ondragend="stophearts(event)" ontouchstart="firehearts(event)" ontouchend="stophearts(event)" ontouchmove="btnanime()">
                                    &#9825</div>
                        </div>
                    </div>
                    <div class="hcprofile_container">
                        <div class="hcprofile">
                            <img id="viewer_pic"></img>
                            <p id="viewer_handle"></p>
                        </div>
                        <div style="font-size:40px;">&#8594;</div>
                        <div class="hcprofile">
                            <img id="streamer_pic"></img>
                            <p id="streamer_handle"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="textarea" id="txt_sec3">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
            </div>
        </div>
    </div>
    <div id="loading-modal" class="modal" style="display:block;">
        <div class="modal-content loading">
            <div class="lds-ripple"><div></div><div></div></div>
        </div>
    </div>
    <footer style="display:flex;justify-content: space-between;align-items:center;">
        <div class="tonicpow-widget" data-widget-type="share-button" data-button-id="myButton"></div>
        <div style="margin:0 30px;"><span id="copyright">©website</span></div>
    </footer>
    <script>
        var x = location.search
        window.onload = async function(){
            let origin = getUrlVars()["ori"]
            if(origin){
                const site = await run.load(origin)
                await site.sync()
                console.log(site)
                sessionStorage.setItem("site",origin)
                loadsite(site)
                let hcauth= sessionStorage.HandCashAuthToken
                if(hcauth){
                    handcashProfile()
                    handcashStreamerProfile()
                    document.getElementById('unlockheartbtn').style.display = "none"
                    document.querySelector(".hcprofile_container").style.display = "flex"
                    document.querySelector(".heartbtn_container").className = "heartbtn_container"
                }
            }
            document.getElementById('loading-modal').style.display = "none"
        }

        function loadsite(site){
            document.getElementById("mystyle").href = site.css.url
            var hero = document.querySelector(".hero")
            hero.style.background = 'url('+ site.heroimgurl+')' 
            document.getElementById('img_sec2').src = site.squareimgurl
            document.getElementById('menu_sec1').innerHTML = site.label[0]
            document.getElementById('menu_sec2').innerHTML = site.label[1]
            document.getElementById('menu_sec3').innerHTML = site.label[2]
            document.getElementById('sitetitle').innerHTML = site.title
            document.getElementById('subtitle').innerHTML = site.subtitle
            document.getElementById('head_sec1').innerHTML = site.label[0]
            document.getElementById('head_sec2').innerHTML = site.label[1]
            document.getElementById('head_sec3').innerHTML = site.label[2]
            document.getElementById('txt_sec1').innerHTML = site.content[0]
            document.getElementById('txt_sec2').innerHTML = site.content[1]
            document.getElementById('txt_sec3').innerHTML = site.content[2]
            document.getElementById('embed_sec3').innerHTML = site.embed
            document.getElementById('copyright').innerHTML = '©' + site.title
            if(site.tipwidget){
                document.getElementById('tip-widget').style.display = "flex"
                sessionStorage.setItem('TipTo',site.tipto)
            }else{
                document.getElementById('tip-widget').style.display = "none"
            }
        }

        //Heart Button
        var k = 0
        function hearts() {
            const div = document.getElementById("bubblehearts")
            for (var i = 0; i <= 3; i++) {
                var size = rnd(60, 120) / 10;
                var h = document.createElement("SPAN")
                h.className = "particle"
                h.style.top = 80 + '%'
                h.style.left = rnd(0, 100) + '%'
                h.style.width = size + 'px'
                h.style.height = size + 'px'
                h.style.animationDelay = i/3 +'s'
                var hdiv = div.appendChild(h)
            }
            //Display Donated Amount
            document.getElementById('heartamount').innerHTML = k+'¢'
            k++
        }
        function rnd(m,n){
            return Math.floor(Math.random() * (n - m + 1)) + m
        }
        function firehearts(event){
            document.getElementById('heartamount').innerHTML = ""
            myHeart = setInterval(hearts,500)
        }
        function stophearts(event){
            var amount = (k-1)/100
            clearInterval(myHeart)
            document.querySelector(".heartbtn_container").style.backgroundColor = "transparent"
            document.querySelector(".heartbtn").innerHTML = "&#9825"
            document.querySelector(".heartbtn").style.backgroundColor = "#cc2a5d"
            document.querySelector(".heartbtn").style.color = "white"
            handcashPay(amount)
            clearhearts()
            k=0
        }
        function btnanime(){
            document.querySelector(".heartbtn").style.backgroundColor = "transparent"
            document.querySelector(".heartbtn").style.color = "black"
            document.querySelector(".heartbtn").style.border = "1px dashed #cc2a5d"
        }
        function clearhearts(){
            const div = document.getElementById("bubblehearts")
            while (div.hasChildNodes()) {  
                div.removeChild(div.firstChild);
            }
        }
        function unlockheart(){
            location.href= 'login.html'
        }

        //HandCash
        async function handcashProfile(){
            console.log('fetching HandCash profile...')
            let authtoken = sessionStorage.HandCashAuthToken
            fetch("https://us-central1-microsite-22755.cloudfunctions.net/hc/profile", {      
            method: "POST",
            body: JSON.stringify({
                authtoken: authtoken
            }),
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
            })
            .then(response => response.json())
            .then(json => {
                console.log(json)
                document.getElementById('viewer_pic').style.display = "block"
                document.getElementById('viewer_pic').src = json.avatarUrl
                document.getElementById('viewer_handle').innerHTML = '$' + json.handle
                localStorage.setItem('hc_avatarURL',json.avatarUrl)
                localStorage.setItem('hc_handle',json.handle)
            });      
        }
        async function handcashStreamerProfile(){
            console.log('fetching HandCash profile...')
            let authtoken = sessionStorage.HandCashAuthToken
            let tipto = sessionStorage.TipTo
            fetch("https://us-central1-microsite-22755.cloudfunctions.net/hc/friend", {      
            method: "POST",
            body: JSON.stringify({
                authtoken: authtoken,
                tipto: tipto
            }),
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
            })
            .then(response => response.json())
            .then(json => {
                console.log(json)
                document.getElementById('streamer_pic').style.display = "block"
                document.getElementById('streamer_pic').src = json.userProfiles[0].avatarUrl
                document.getElementById('streamer_handle').innerHTML = '$' + json.userProfiles[0].handle
            });      
        }
        async function handcashPay(amount){
            console.log('paying ' + amount+' USD with HandCash...')
            let authtoken = sessionStorage.HandCashAuthToken
            let tipto = sessionStorage.TipTo
            fetch("https://us-central1-microsite-22755.cloudfunctions.net/hc/pay", {      
            method: "POST",
            body: JSON.stringify({
                authtoken: authtoken,
                amount:amount,
                tipto: tipto
            }),
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
            })
            .then(response => response.json())
            .then(json => {
                console.log(json)
                sendchatheart(amount)
            });      
        }

        //Chat
        const socket = io(`wss://buildmicro.site`,{
            //path: "/chat/",
            //transports: ["websocket"]
            });
        socket.on("connect", () => {
            console.log("socket connected",socket.connected);
            console.log("socket id", socket.id);
        });
        socket.on("disconnect", () => {
            console.log("socket connected",socket.connected);
            console.log("socket id", socket.id);
        });
        socket.on("connect_error", (err) => {
            console.log("socket connect error:", err.toString())
        });
        socket.on('chat message', function(amount,user) {
          var cents = Math.round(amount * 100);
          var messages = document.getElementById('messages')
          var item = document.createElement('li');
          var img = document.createElement('IMG');
          var span = document.createElement('SPAN');    
          var t = document.createTextNode(`${user.handle} tipped ${cents}¢`);
          span.appendChild(t)
          img.src = user.avatar
          img.className = 'chat_pic'
          item.appendChild(img)
          item.appendChild(span)
          messages.insertBefore(item, messages.childNodes[0])
        });
        function sendchatheart(amount){
            var avatar = localStorage.hc_avatarURL
            var handle = localStorage.hc_handle
            socket.emit('chat message', amount, {avatar:avatar,handle:handle});
        }
    </script>
</body>
</html>